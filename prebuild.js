const fs = require('fs');
const packageJson = require('./package.json');

const imprint = `
  <h2>Herausgeber</h2>
  <h3>Firmenname</h3>
    <p>
      Firmenadresse
    </p>

    <p>
      Kontaktdaten
    </p>

  <h2>Rechtliche Hinweise</h2>
    <p>
      Hinweise
    </p>

  <h2>Realisierung</h2>
    <p>
      Design, Entwicklung
    </p>
    <p>
      Dataport<br>
      Anstalt öffentlichen Rechts<br>
      Altenholzer Straße 10-14<br>
      24161 Altenholz<br>
      Tel.: +49 (0)431 3295-0<br>
      Fax.: +49 (0)431 3295-0<br>
    </p>
    <p>
      E-Mail: <a href="mailto:dataportdabstimmbox@dataport.de">dataportdabstimmbox@dataport.de</a>
    </p>

  <h2>Inhalte</h2>
    <p>
      Für Vollständigkeit, Fehler redaktioneller und technischer Art, Auslassungen sowie die Richtigkeit der Eintragungen kann keine
      Haftung übernommen werden. Insbesondere kann keine Gewähr für die Vollständigkeit und Richtigkeit von Informationen übernommen
      werden, die über weiterführende Links erreicht werden.
    </p>
    <p>
      Anbieter dieser Links sind für die eigenen Inhalte, die sie zur Nutzung bereithalten, nach den allgemeinen Gesetzen
      verantwortlich. Von diesen eigenen Inhalten sind Querverweise auf die von anderen Anbietern bereitgehaltenen Inhalte zu
      unterscheiden.
    </p>

  <div>Stand 13. September 2022</div>
`;
const privacy = `<h2>privacy</h2>`;
const tos = `<h2>tos</h2>`;
const accessibility = `<h2>accessibility</h2>`;

function reformat(value) {
  if (value === undefined) {
    return value;
  }
  return `'${value}'`;
}

function isBoolean(value) {
  return value === 'true' || value === 'false';
}

fs.readFile('./src/environments/environment.ts.tmpl', 'utf8', function (err, data) {
  if (err) {
    throw err;
  }

  if (process.env.DOCKER === 'true') {
    console.log('Build with docker mode');
    data = data
      .replace('@TITLE@', reformat('@TITLE@'))
      .replace('@LOCALE@', reformat('@LOCALE@'))
      .replace('@ADDRESSING@', reformat('@ADDRESSING@'))
      .replace('@API_URL@', reformat('@API_URL@'))
      .replace('@CUSTOMER_ID@', reformat('@CUSTOMER_ID@'))
      .replace('@COLORS@', reformat('@COLORS@'))
      .replace('@IMPRINT@', reformat('@IMPRINT@'))
      .replace('@PRIVACY@', reformat('@PRIVACY@'))
      .replace('@TOS@', reformat('@TOS@'))
      .replace('@ACCESSIBILITY@', reformat('@ACCESSIBILITY@'));
  } else {
    console.log('Build with classic mode');
    data = data
      .replace('@TITLE@', reformat(process.env.TITLE ? process.env.TITLE : ''))
      .replace('@LOCALE@', reformat(process.env.LOCALE ? process.env.LOCALE : 'de-DE'))
      .replace('@ADDRESSING@', reformat(process.env.ADDRESSING ? process.env.ADDRESSING : 'du'))
      .replace('@API_URL@', reformat(process.env.API_URL))
      .replace('@CUSTOMER_ID@', reformat(process.env.CUSTOMER_ID ? process.env.CUSTOMER_ID : '11111111-1111-1111-1111-111111111111'))
      .replace('@COLORS@', reformat(btoa(process.env.COLORS ? process.env.COLORS : '{}')))
      .replace('@IMPRINT@', reformat(btoa(process.env.IMPRINT ? process.env.IMPRINT : `${imprint}`)))
      .replace('@PRIVACY@', reformat(btoa(process.env.PRIVACY ? process.env.PRIVACY : `${privacy}`)))
      .replace('@TOS@', reformat(btoa(process.env.TOS ? process.env.TOS : `${tos}`)))
      .replace('@ACCESSIBILITY@', reformat(btoa(process.env.ACCESSIBILITY ? process.env.ACCESSIBILITY : `${accessibility}`)));
  }

  data = data
    .replace('@GENERATED_COMMENT_TS@', '// AUTO GENERATED - DO NOT EDIT THIS FILE')
    .replace('@VERSION@', reformat(process.env.VERSION ? process.env.VERSION : packageJson.version))
    .replace('@CONSOLE_LOGGING_OPTIONS@', `{momentDateTimeFormat: 'YYYY-MM-DD HH:mm:ss.SSS', logLevelThreshold: LogLevel.WARN}`)
    .replace('@BUILD_DATE@', reformat(new Date().toISOString()))
    .replace('@SURVEY_LINK_ADMIN@', reformat(process.env.SURVEY_LINK_ADMIN ? process.env.SURVEY_LINK_ADMIN : undefined))
    .replace('@SURVEY_LINK_USER@', reformat(process.env.SURVEY_SURVEY_LINK_USER ? process.env.SURVEY_SURVEY_LINK_USER : undefined))
    .replace('@EMAIL@', reformat(process.env.EMAIL ? process.env.EMAIL : 'demo@example.com'))
    .replace('@SHOW_REFERENCE@', isBoolean(process.env.SHOW_REFERENCE) ? process.env.SHOW_REFERENCE : 'true')
    .replace('@API_REQUEST_TIMEOUT_IN_MS@', '20000')
    .replace('@API_MEDIA_TYPE@', reformat(process.env.API_MEDIA_TYPE ? process.env.API_MEDIA_TYPE : 'application/terminfinder.api-v1+json'));

  fs.writeFile('./src/environments/environment.ts', data, 'utf8', function (err) {
    if (err) {
      throw err;
    }
  });
});

fs.readFile('./src/index.html.tmpl', 'utf8', function (err, data) {
  if (err) {
    throw err;
  }

  data = data
    .replace('@TITLE@', process.env.TITLE);

  fs.writeFile('./src/index.html', data, 'utf8', function (err) {
    if (err) {
      throw err;
    }
  });
});
